<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaPet: The Ultimate PYQ Quest</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f0f2f5; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .app-container { background: white; width: 100%; max-width: 450px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        
        .screen { padding: 25px; display: none; }
        .active { display: block; }

        /* Mascot & Layered UI */
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .pet-stage { 
            position: relative; 
            width: 160px; 
            height: 160px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 6rem;
        }
        /* Accessory Positioning */
        .acc { position: absolute; pointer-events: none; transition: all 0.3s; }
        .acc-aura { font-size: 8rem; z-index: 1; opacity: 0.8; }
        .acc-body { font-size: 4rem; bottom: 0; z-index: 3; }
        .acc-eyes { font-size: 2.5rem; top: 45px; z-index: 4; }
        .acc-head { font-size: 3rem; top: -5px; z-index: 5; }
        .acc-hand { font-size: 2.5rem; right: 0; bottom: 20px; z-index: 4; }

        .mood-container { width: 80%; background: #ddd; height: 12px; border-radius: 6px; margin: 10px auto; overflow: hidden; border: 2px solid white; }
        #moodBar { width: 100%; height: 100%; background: #2ecc71; transition: width 0.5s; }

        .stats { display: flex; justify-content: space-around; background: #eee; padding: 10px; font-weight: bold; }
        .mission-card { background: #e8f4fd; border-left: 5px solid var(--primary); padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; line-height: 1.4; }
        input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; font-size: 1.1rem; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s; }
        .btn-check { background: var(--primary); }
        .btn-mcq { background: #3498db; }
        .btn-mcq:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-shop { background: var(--gold); color: #333; }
        .btn-music { background: rgba(255,255,255,0.2); border: 1px solid white; font-size: 0.8rem; padding: 5px 10px; width: auto; margin-top: 10px; }

        .shop-grid { display: grid; grid-template-columns: 1fr; gap: 8px; max-height: 300px; overflow-y: auto; }
        .owned { opacity: 0.6; border: 2px solid #2ecc71 !important; position: relative; }
        .owned::after { content: "‚úÖ Owned"; position: absolute; right: 10px; color: #2ecc71; font-size: 0.7rem; }
    </style>
</head>
<body>

<audio id="bgMusic" loop><source src="lab-ambience.mp3" type="audio/mpeg"></audio>

<div class="app-container">
    <div id="screen-login" class="screen active">
        <h2 style="text-align:center">PharmaPet üß™</h2>
        <p style="text-align:center">Choose your lab assistant:</p>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            <div style="font-size:3rem; cursor:pointer; text-align:center;" onclick="savePet('üê±')">üê±</div>
            <div style="font-size:3rem; cursor:pointer; text-align:center;" onclick="savePet('üê∂')">üê∂</div>
            <div style="font-size:3rem; cursor:pointer; text-align:center;" onclick="savePet('ü¶ä')">ü¶ä</div>
            <div style="font-size:3rem; cursor:pointer; text-align:center;" onclick="savePet('üêº')">üêº</div>
            <div style="font-size:3rem; cursor:pointer; text-align:center;" onclick="savePet('üê®')">üê®</div>
            <div style="font-size:3rem; cursor:pointer; text-align:center;" onclick="savePet('ü¶Å')">ü¶Å</div>
        </div>
    </div>

    <div id="screen-lab" class="screen">
        <div class="header">
            <div class="pet-stage">
                <div id="auraLayer" class="acc acc-aura"></div>
                <div id="bodyLayer" class="acc acc-body"></div>
                <div id="mainPet">üê±</div>
                <div id="eyeLayer" class="acc acc-eyes"></div>
                <div id="headLayer" class="acc acc-head"></div>
                <div id="handLayer" class="acc acc-hand"></div>
            </div>
            <div class="mood-container"><div id="moodBar"></div></div>
            <button class="btn btn-music" id="musicBtn" onclick="toggleMusic()">üîà Music: OFF</button><br>
            <small id="rankText">Intern Chemist</small>
        </div>
        
        <div class="stats">
            <span>üí∞ <span id="score">0</span> pts</span>
            <span>üß™ Lvl <span id="levelNum">1</span></span>
        </div>

        <div class="content">
            <div id="missionText" class="mission-card">Loading...</div>
            <div id="calcInputArea">
                <input type="number" id="userValue" placeholder="Enter result">
                <button class="btn btn-check" onclick="checkAnswer()">Verify Formulation</button>
            </div>
            <div id="mcqOptions" style="display: none; flex-direction: column; gap: 8px;"></div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn" style="background:#3498db" onclick="showScreen('screen-feed')">Feed üçé</button>
                <button class="btn btn-shop" onclick="showScreen('screen-shop')">Shop üõí</button>
            </div>
            <div id="feedback" style="text-align:center; font-weight:bold; min-height: 20px; margin-top: 5px;"></div>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <h2>Prestige Boutique üõí</h2>
        <div class="shop-grid" id="shopList">
            </div>
        <button class="btn" style="background:var(--primary); margin-top:15px;" onclick="showScreen('screen-lab')">Return to Lab</button>
    </div>

    <div id="screen-feed" class="screen">
        <h2>Nutrition Station</h2>
        <button class="btn" style="background:#2ecc71" onclick="feedPet(30, 40)">Pure Glucose (-40 pts)</button>
        <button class="btn" style="background:var(--primary)" onclick="showScreen('screen-lab')">Back</button>
    </div>
</div>

<script>
    const items = [
        { id: 'coat', label: 'Lab Coat', icon: 'ü•º', cost: 50, slot: 'body' },
        { id: 'goggles', label: 'Safety Goggles', icon: 'ü•Ω', cost: 80, slot: 'eyes' },
        { id: 'shield', label: 'Face Shield', icon: 'üõ°Ô∏è', cost: 120, slot: 'eyes' },
        { id: 'flask', label: 'Erlenmeyer Flask', icon: 'üß™', cost: 150, slot: 'hand' },
        { id: 'crown', label: 'Chief Crown', icon: 'üëë', cost: 250, slot: 'head' },
        { id: 'sparkles', label: 'Sparkle Aura', icon: '‚ú®', cost: 350, slot: 'aura' },
        { id: 'gown', label: 'Professor Gown', icon: 'üéì', cost: 450, slot: 'head' }
    ];

    const missions = [
        { lvl: 1, isMCQ: true, text: "What is the molecular geometry of SO2?", options: ["T-shaped", "Linear", "Bent", "Trigonal Planar"], correct: "Bent" },
        { lvl: 1, isMCQ: true, text: "Which geometry is associated with BF3?", options: ["Trigonal Planar", "Tetrahedral", "Bent", "Linear"], correct: "Trigonal Planar" },
        { lvl: 1, isMCQ: true, text: "VBT Theory: A covalent bond forms when attractive forces are _____ than repulsive forces.", options: ["Smaller", "Equal", "Greater", "Zero"], correct: "Greater" },
        { lvl: 1, text: "Calculate grams of NaOH (MW: 40) for 1.5 L of 0.1 M solution.", calc: () => 6.00 },
        { lvl: 2, isMCQ: true, text: "IUPAC name for Ni(CO)4?", options: ["Nickel carbonyl", "Tetracarbonylnickel(0)", "Nickel(IV) carbonyl", "Carbonylnickel"], correct: "Tetracarbonylnickel(0)" },
        { lvl: 2, isMCQ: true, text: "Solubility product expression (Ksp) for Ag2SO4?", options: ["Ksp = [Ag+][SO4^2-]", "Ksp = [Ag+]^2[SO4^2-]", "Ksp = [Ag+][SO4^2-]^2", "Ksp = 2[Ag][SO4]"], correct: "Ksp = [Ag+]^2[SO4^2-]" },
        { lvl: 2, isMCQ: true, text: "Hybridisation of P in PCl5?", options: ["sp2", "sp3", "sp3d", "sp3d2"], correct: "sp3d" },
        { lvl: 3, isMCQ: true, text: "Bond order for oxygen molecule cation (O2+)?", options: ["1", "1.5", "2", "2.5"], correct: "2.5" },
        { lvl: 3, text: "Buffer: [A-] = 0.5 M, [HA] = 0.05 M, pKa = 3.8. Find pH.", calc: () => 4.80 },
        { lvl: 3, text: "Target pH: 5.2, pKa: 4.2. Find required [A-]/[HA] ratio.", calc: () => 10.00 }
    ];

    let state = JSON.parse(localStorage.getItem('pharmaPetLayers')) || { 
        score: 0, mood: 100, pet: null, ownedItems: [] 
    };
    
    let currentTask = {};
    let isMusicPlaying = false;
    const music = document.getElementById('bgMusic');

    function toggleMusic() {
        if (!isMusicPlaying) {
            music.play().catch(e => alert("Interact first!"));
            document.getElementById('musicBtn').innerText = "üîä Music: ON";
            isMusicPlaying = true;
        } else {
            music.pause();
            document.getElementById('musicBtn').innerText = "üîà Music: OFF";
            isMusicPlaying = false;
        }
    }

    function savePet(pet) { state.pet = pet; saveAndSync(); showScreen('screen-lab'); }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'screen-lab') nextMission();
        if(id === 'screen-shop') renderShop();
    }

    function renderShop() {
        const list = document.getElementById('shopList');
        list.innerHTML = '';
        items.forEach(item => {
            const isOwned = state.ownedItems.includes(item.id);
            const btn = document.createElement('button');
            btn.className = `btn ${isOwned ? 'owned' : ''}`;
            btn.style.background = isOwned ? '#eee' : '#34495e';
            btn.style.color = isOwned ? '#aaa' : 'white';
            btn.innerText = `${item.label} (${item.cost} pts)`;
            btn.onclick = () => buyItem(item);
            list.appendChild(btn);
        });
    }

    function buyItem(item) {
        if(state.ownedItems.includes(item.id)) return;
        if(state.score >= item.cost) {
            state.score -= item.cost;
            state.ownedItems.push(item.id);
            saveAndSync();
            renderShop();
        } else { alert("Insufficient points! Solve more PYQs."); }
    }

    function saveAndSync() {
        localStorage.setItem('pharmaPetLayers', JSON.stringify(state));
        document.getElementById('score').innerText = state.score;
        document.getElementById('mainPet').innerText = state.pet;
        document.getElementById('moodBar').style.width = state.mood + "%";
        
        // Clear all layers
        ['auraLayer','bodyLayer','eyeLayer','headLayer','handLayer'].forEach(l => document.getElementById(l).innerText = '');
        
        // Populate layers based on owned items
        state.ownedItems.forEach(itemId => {
            const item = items.find(i => i.id === itemId);
            if(item) document.getElementById(`${item.slot}Layer`).innerText = item.icon;
        });

        let r = "Intern";
        if(state.score >= 100) r = "Junior Researcher";
        if(state.score >= 300) r = "Senior Pharmacist";
        if(state.score >= 700) r = "Chief Director";
        document.getElementById('rankText').innerText = r;
    }

    function nextMission() {
        document.getElementById('feedback').innerText = '';
        document.getElementById('userValue').value = '';
        let filtered = missions.filter(m => (state.score < 100 ? m.lvl === 1 : state.score < 300 ? m.lvl === 2 : m.lvl === 3));
        currentTask = filtered[Math.floor(Math.random() * filtered.length)];
        document.getElementById('missionText').innerText = currentTask.text;
        document.getElementById('levelNum').innerText = currentTask.lvl;

        if (currentTask.isMCQ) {
            document.getElementById('calcInputArea').style.display = 'none';
            const mcqArea = document.getElementById('mcqOptions');
            mcqArea.style.display = 'flex'; mcqArea.innerHTML = '';
            currentTask.options.forEach(opt => {
                const b = document.createElement('button');
                b.className = "btn btn-mcq"; b.innerText = opt;
                b.onclick = () => processResult(opt === currentTask.correct);
                mcqArea.appendChild(b);
            });
        } else {
            document.getElementById('calcInputArea').style.display = 'block';
            document.getElementById('mcqOptions').style.display = 'none';
        }
    }

    function checkAnswer() {
        const val = parseFloat(document.getElementById('userValue').value);
        processResult(Math.abs(val - currentTask.calc()) < 0.1);
    }

    function processResult(isCorrect) {
        const fb = document.getElementById('feedback');
        if (isCorrect) {
            state.score += 25; state.mood = Math.min(100, state.mood + 10);
            fb.innerText = "‚úÖ Correct! Score +25"; fb.style.color = "green";
            setTimeout(nextMission, 1000);
        } else {
            state.score = Math.max(0, state.score - 5); state.mood = Math.max(0, state.mood - 20);
            fb.innerText = "‚ùå Incorrect. Try again."; fb.style.color = "red";
        }
        saveAndSync();
    }

    function feedPet(boost, cost) {
        if(state.score >= cost) { state.score -= cost; state.mood = Math.min(100, state.mood + boost); saveAndSync(); showScreen('screen-lab'); }
    }

    if(state.pet) { showScreen('screen-lab'); saveAndSync(); }
</script>
</body>
</html>
